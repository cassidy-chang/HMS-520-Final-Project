---
title: "HMS 520 Final Project"
author: "Cassidy Chang, Yaz Ozten, and Sinclair Carr"
output: pdf_document

---

```{r}
rm(list = ls())
library("data.table")
library("ggplot2")


```




### Part I: Data Wrangling
  - Change names to be more readable and intuitive
  - CD4 (upper and lower) - multiply by 10
  - Sum CD4 variables into one to get average CD4 count
  - Separate age variable (lower limit and upper limit)
  - Create a variable indicating the length of study

```{r}

data <- setDT(read_excel("on-art_mort.xlsx"))
setnames(data, c("nid", "super", "meas_value", "meas_stdev", "iso3", "time_point", "age"), 
         c("study_id", "gbd_superregion", "p_mortality", "sd_p_mortality", "country_code", "time_since_art", "age_group"))

data[, `:=` ("cd4_lower" = CD4_lower * 10, "cd4_upper" = CD4_upper * 10)]
data[, study_length := time_upper - time_lower]
data[, cd4_mid := (cd4_upper + cd4_lower)/2]
data[, sex := as.factor(ifelse(sex == 1, "male", "female"))]

# Identify missing values 

colnames(data)[colSums(is.na(data)) > 0]
sum(is.na(data$p_mortality)) # 20
sum(is.na(data$sd_p_mortality)) # 20
sum(is.na(data$site)) # 360


```

  
### Part II: Data Analysis
  - Descriptive analysis
  - Attempt k-means/agglomerative/spectral clustering and see if predictive of time since ART 
  - Running different regression models with different sets of covariates and mortality and use of ART as outcomes
  - Comparing models with select goodness of fit tests

```{r}
summary(data, digits = 2)
by(data, data$gbd_superregion, summary)
by(data, data$age_group, summary)

table(data$sex, data$time_since_art)
prop.table(table(data$sex, data$time_since_art))

boxplot(data$p_mortality~data$age_group) # Age and probability of mortality may be slightly correlated
boxplot(data$p_mortality~data$time_since_art) # A lot of the data seems to be clustered in the time-since-art range of 6 months. Probability of mortality seems to decrease as time-since-art increases (from 6 to 12 to 24 months)

model2 <- lm(formula = p_mortality ~ sex + age_group + time_since_art, data = data) # The above seems to be more or less true as we can see by running the linear model of probability of mortality against sex, age group and time since art
anova(model2)


model1 <- p_mortality ~ sex + age + gbd_superregion
```


### Part III: Visualization
  - Plot regression outputs 
  - Plot goodness of fit tests
  - Visualization with PCA and TSNE 

```{r}

```


