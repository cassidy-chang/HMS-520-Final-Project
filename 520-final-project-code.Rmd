---
title: "HMS 520 Final Project"
author: "Cassidy Chang, Yaz Ozten, and Sinclair Carr"
output: pdf_document

---

```{r}
rm(list = ls())
library("data.table")
library("ggplot2")
library("stats")
library("tidyverse")
library("mclust")
library("readr")
library("ggfortify")
library("readxl")
library("Rtsne")
library("factoextra")
library("cluster")
library("clue")

```




### Part I: Data Wrangling
  - Change names to be more readable and intuitive
  - CD4 (upper and lower) - multiply by 10
  - Sum CD4 variables into one to get average CD4 count
  - Separate age variable (lower limit and upper limit)
  - Create a variable indicating the length of study

```{r}

data <- setDT(read_excel("on-art_mort.xlsx"))
setnames(data, c("nid", "super", "meas_value", "meas_stdev", "iso3", "time_point", 
                 "age", "CD4_lower", "CD4_upper"), c("study_id", "gbd_superregion", 
                "p_mortality", "sd_p_mortality", "country_code", "time_since_art", 
                "age_group", "cd4_lower", "cd4_upper"))

data[, `:=` ("cd4_lower" = cd4_lower * 10, "cd4_upper" = cd4_upper * 10)]
data[, study_length := time_upper - time_lower]
data[, cd4_mid := (cd4_upper + cd4_lower)/2]
data[, sex := as.factor(ifelse(sex == 1, "male", "female"))]

# Identify missing values 

colnames(data)[colSums(is.na(data)) > 0]
sum(is.na(data$p_mortality)) # 20
sum(is.na(data$sd_p_mortality)) # 20
sum(is.na(data$site)) # 360

View(data)

```

  
### Part IIa: Summary statistics 
  - Descriptive analysis
  - Attempt k-means/agglomerative/spectral clustering and see if predictive of time since ART 
  - Running different regression models with different sets of covariates and mortality and use of ART as outcomes
  - Comparing models with select goodness of fit tests

```{r}
summary(data, digits = 2)
by(data, data$gbd_superregion, summary)
by(data, data$age_group, summary)
table(data$sex, data$time_since_art)
prop.table(table(data$sex, data$time_since_art)) # Summaries of general descriptive statistics based on GBD super region and age group, as well as proportions of participants in the data set based on time since ART.

boxplot(data$p_mortality~data$age_group) # Age and probability of mortality may be slightly correlated
boxplot(data$p_mortality~data$time_since_art) # Much of the data seems to be clustered in the range of six months since ART. Probability of mortality seems to decrease as time since ART increases (from six to 12 to 24 months)

model2 <- lm(formula = p_mortality ~ sex + age_group + time_since_art, data = data)
library("rigr")
regress("odds", formula = p_mortality ~ sex + age_group + time_since_art, data = data) # The above seems to be more or less true as we can see by running the linear model of probability of mortality against sex, age group and time since ART

model1 <- p_mortality ~ sex + age + gbd_superregion
```

### Part IIb: Unsupervised learning - clustering 
```{r}
# Using numeric data, predict time_since_art with clustering (unsupervised learning)

# Select only numeric variables 
numeric_variables <- data[, c("p_mortality", "sd_p_mortality", "cd4_lower", "cd4_upper", 
                          "cd4_mid", "time_since_art", "sample_size", "study_length")]

# Preprocessing - scale values before unsupervised algorithm implementation
numeric_variables <- scale(replace(numeric_variables, is.na(numeric_variables), 0))

# Retrieve data on time period since ART 
true_clusters <- matrix(data$time_since_art)
prev_tsa <- c(6, 12, 24)
new_tsa <- 1:3
# Transform 6, 12, 24 to 1, 2, 3
true_clusters[true_clusters %in% prev_tsa] <- new_tsa[match(true_clusters, prev_tsa)]

# Cluster accuracy function to compute fair predictive accuracy of clustering
cluster_accuracy <- function(pred_clusters, ground_truth) {
  pts <- matrix(0, 3, 3)
  # +1 at each of (pred_clusters, ground_truth) in pts matrix
  for (val in 1:length(pred_clusters)){
    pts[pred_clusters[val], ground_truth[val]] <- 1 + 
      pts[pred_clusters[val], ground_truth[val]]}
  # Form bipartite graph by subtracting pts from max value in pts 
  bp_graph <- matrix(max(pts), 3, 3) - pts
  # Solve linear assignment problem using Hungarian algorithm 
  bp_sol <- solve_LSAP(bp_graph, maximum = FALSE)
  # Compute accuracy: sum values given by LSAP solution, divide by total no.
  accuracy <- (pts[1, bp_sol[1]] + pts[2, bp_sol[2]] + pts[3, bp_sol[3]]) / length(pred_clusters)
  return(accuracy)}

# Clustering
# Set up empty variables for future accuracy imputation
k_accuracies <- rep(NA, 10)
pam_accuracies <- rep(NA, 10)
agglom_accuracies <- rep(NA, 10)
model_accuracies <- rep(NA, 10)

# Set seed for reproducibility
set.seed(0)

for (i in 1:10) {
  # k-means clustering 
  k_results <- kmeans(as.matrix(numeric_variables), centers = 3, nstart = 1)
  k_clusters <- matrix(k_results$cluster)
  k_accuracies[i] <- cluster_accuracy(k_clusters, true_clusters)
  
  # k-medoids clustering (partition around medoids) 
  pam_results <- pam(as.matrix(numeric_variables), k = 3, nstart = 1)
  pam_clusters <- matrix(pam_results$clustering)
  pam_accuracies[i] <- cluster_accuracy(pam_clusters, true_clusters)
  
  # hierarchical clustering using Euclidean distance matrix
  dist_matrix <- dist(numeric_variables, method = "euclidean")
  h_results <- hclust(dist_matrix, method = "ward.D")
  sliced_results <- cutree(h_results, k = 3)
  agglom_clusters <- matrix(sliced_results)
  agglom_accuracies[i] <- cluster_accuracy(agglom_clusters, true_clusters)
  
  # model-based clustering 
  model_results <- Mclust(numeric_variables, G = 3)
  model_clusters <- model_results$classification
  model_accuracies[i] <- cluster_accuracy(model_clusters, true_clusters)}

# Calculate average predictive accuracy based on 10 accuracy values for each 
# clustering method 
k_mean_accuracy <- mean(k_accuracies)
pam_mean_accuracy <- mean(pam_accuracies)
agglom_mean_accuracy <- mean(agglom_accuracies)
model_mean_accuracy <- mean(model_accuracies)

cat("Mean k-means predictive accuracy is:", k_mean_accuracy, 
    "\nMean k-medoids predictive accuracy is:", pam_mean_accuracy, 
    "\nMean agglomerative predictive accuracy is:", agglom_mean_accuracy, 
    "\nMean model-based predictive accuracy is:", model_mean_accuracy)

```




### Part IIIa: Visualization with PCA and tSNE


```{r}

# Prepare variables for PCA and tSNE
numeric_variables <- data[, c("p_mortality", "sd_p_mortality", "cd4_lower", "cd4_upper", 
                          "cd4_mid", "time_since_art", "sample_size", "study_length")]
numeric_variables <- scale(replace(numeric_variables, is.na(numeric_variables), 0))

# PCA visualization 
pca_result <- prcomp(numeric_variables)
summary(pca_result)
autoplot(pca_result, colour = data$time_since_art)

# tSNE visualization 
data_tsne <- Rtsne(numeric_variables, perplexity = 10, check_duplicates = FALSE)
plot(data_tsne$Y, col = data$time_since_art)

```


